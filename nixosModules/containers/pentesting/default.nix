{
  config,
  pkgs,
  lib,
  vars,
  ...
}:

let
  hostUser = "5ysk3y";
in
{
  containers.pentesting = {
    autoStart = false;
    ephemeral = false;

    privateNetwork = true;
    hostAddress = "192.168.100.1";
    localAddress = "192.168.100.2";
    enableTun = true;

    bindMounts = {
      # Wayland socket, lets GUI apps render on the host session
      "/run/wayland/wayland-1" = {
        hostPath = "/run/user/1000/wayland-1";
        isReadOnly = true;
      };

      # X11 socket, for specific apps, e.g. burp
      "/tmp/.X11-unix" = {
        hostPath = "/tmp/.X11-unix";
        isReadOnly = true;
      };

      # Optional, give the container a scratch workspace on the host
      "/home/${hostUser}/HTB" = {
        hostPath = "/home/${vars.username}/Sync/Cyber/Platforms/HTB";
        isReadOnly = false;
      };
    };

    config =
      { pkgs, ... }:
      {
        system.stateVersion = "25.05";

        nix = {
          extraOptions = ''
            experimental-features = nix-command flakes
          '';
        };

        nixpkgs.config.allowUnfree = true;

        networking = {
          useHostResolvConf = false;
          nameservers = [
            "1.1.1.1"
            "9.9.9.9"
          ];
        };

        users.users.${hostUser} = {
          isNormalUser = true;
          extraGroups = [
            "wheel"
            "wireshark"
          ];
          uid = 1000;
          home = "/home/${hostUser}";
          createHome = true;
        };

        security.sudo.wheelNeedsPassword = false;

        environment = {
          sessionVariables = {
            XDG_RUNTIME_DIR = "/run/user/1000";
            WAYLAND_DISPLAY = "/run/wayland/wayland-1";
            DISPLAY = ":0";
            QT_QPA_PLATFORM = "wayland";
            MOZ_ENABLE_WAYLAND = "1";
            TERM = "xterm";
            SECLISTS = "$(wordlists_path)/seclists";
          };
          etc.hosts.enable = false;
        };

        systemd.services.htb-vpn = {
          description = "HackTheBox OpenVPN";
          after = [ "network-online.target" ];
          wants = [ "network-online.target" ];
          wantedBy = [ "multi-user.target" ];

          serviceConfig = {
            ExecStart = "${pkgs.openvpn}/bin/openvpn --config /home/${hostUser}/HTB/VPN/release_arena_eu-release-1.ovpn";
            Restart = "on-failure";
            RestartSec = 3;
          };
        };

        programs.wireshark.enable = true;

        environment.systemPackages = with pkgs; [
          bashInteractive
          coreutils
          git
          curl
          wget
          openssh
          openvpn
          python3
          python3Packages.pip
          tmux
          vim

          nmap
          netcat
          socat
          tcpdump
          traceroute
          inetutils

          ffuf
          gobuster
          thc-hydra
          john
          hashcat
          sqlmap
          seclists
          wordlists

          burpsuite
          firefox
          remmina
          wireshark
        ];

        networking.firewall.enable = true;

        services.openssh.enable = true;
        services.openssh.settings = {
          PasswordAuthentication = false;
          PermitRootLogin = "no";
        };
      };
  };
}
