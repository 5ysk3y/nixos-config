name: NixOS CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - "README.md"
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.jpeg"
      - "**/*.jpg"
      - "**/*.svg"
  pull_request:
    paths-ignore:
      - "README.md"
      - "docs/**"
      - "**/*.md"
      - "**/*.png"
      - "**/*.jpeg"
      - "**/*.jpg"
      - "**/*.svg"

jobs:
  fmt-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - name: Nix format check (nixfmt-tree)
        run: |
          set -euo pipefail
          nix run nixpkgs#nixfmt-tree -- .
          git diff --exit-code || {
            echo ""
            echo "Formatting required."
            echo "Run this locally to fix:"
            echo "  nix run nixpkgs#nixfmt-tree -- ."
            echo ""
            exit 1
          }

  eval-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - name: Basic flake shape checks, no secrets
        run: |
          nix flake show --no-write-lock-file
          nix eval .#nixosConfigurations.gibson.pkgs.stdenv.hostPlatform.system --no-write-lock-file

  flake-secrets-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - name: Free up disk space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet \
                      /opt/ghc \
                      /opt/hostedtoolcache \
                      /usr/local/lib/android
          df -h

      - name: Start ssh-agent and add deploy key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.CI_GITHUB_SSH_KEY }}

      - name: Add GitHub to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Prepare age key in runner temp
        run: |
          mkdir -p "$RUNNER_TEMP/age"
          printf "%s" "${{ secrets.SOPS_AGE_KEY }}" > "$RUNNER_TEMP/age/keys.txt"
          chmod 0600 "$RUNNER_TEMP/age/keys.txt"
          echo "SOPS_AGE_KEY_FILE=$RUNNER_TEMP/age/keys.txt" >> "$GITHUB_ENV"

      - name: Flake check with secrets input override
        run: |
          nix flake check \
            --no-write-lock-file \
            --override-input nix-secrets \
              "git+ssh://git@github.com/5ysk3y/nix-secrets.git?ref=main&shallow=1"
