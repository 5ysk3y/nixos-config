#!/usr/bin/env bash
set -euo pipefail

# Collect staged .nix files as NUL delimited
staged_nix_files=()
while IFS= read -r -d '' f; do
  case "$f" in
    *.nix) staged_nix_files+=("$f") ;;
  esac
done < <(git diff --cached --name-only -z --diff-filter=ACMR)

if (( ${#staged_nix_files[@]} > 0 )); then
  echo "Formatting staged Nix files"
  nix run nixpkgs#nixfmt -- "${staged_nix_files[@]}"
  git add -- "${staged_nix_files[@]}"
else
  echo "No staged Nix files to format"
fi

echo "Statix"
nix run nixpkgs#statix -- check .